# OutBox Pattern
`OutBox`는 `MSA`처럼 데이터베이스가 분산된 환경에서 메세지 브로커와 같은 외부 시스템을 사용하여 이벤트를 처리할 때 데이터의 일관성과 원자성을 맞추기 위해서 사용하는 이벤트 기반 아키텍쳐 패턴입니다. 

## MSA와 같은 분산 환경에서의 문제점

예를 들어, 원서 제출 시스템에서 원서 제출 서비스가 성공하여 데이터베이스에 커밋이 되었지만 네트워크 오류나 메세지 브로커(`Kafka`)의 오류로 인해서 원서 제출 이벤트 발행이 실패할 경우, 원서는 제출되었지만 원서의 상태는 미제출로 남아 데이터의 정합성이 문제 될 수 있습니다.

반대로 원서 제출 시스템에서 원서 제출 서비스의 데이터베이스 커밋 과정에서 오류가 발생하여 커밋이 롤백되었지만 이벤트가 발행되어 원서의 상태는 제출되어 데이터의 정합성이 문제 될 수 있습니다.

이러한 문제를 해결하기 위해 분산 환경에서 `OutBox Pattern`을 적용합니다.

# OutBox Flow
<img width="731" height="580" alt="Image" src="https://github.com/user-attachments/assets/15d223f5-a6a5-46a9-88b3-57afd4a838fc" />
## 1. OutBox 테이블에 이벤트 저장
- 위 예시와 같이 원서 제출 서비스에서 원서 제출을 하여 `Kafka` 이벤트를 발행합니다. 이 때 `Kafka` 이벤트 발행과 원서 제출을 같은 트랜잭션으로 설계합니다. 그 이유는 원서 제출 서비스에서 커밋이 롤백되어도 이벤트 발행도 함께 롤백되도록 설계하여 데이터의 정합성을 맞추기 위해서입니다.

이 때 커밋과 함께 발행되는 이벤트 로직은 OutBox 테이블에 이벤트 정보를 저장하는 행위를 말합니다.
## 2. CDC를 통해 추적 후 이벤트 발행
- `CDC`가 `OutBox` 테이블을 추적하여 새로운 이벤트가 생기면 `Kafka`로 발행합니다. 이 과정에서 `Spring Retry`를 사용한 재시도 로직을 사용하여 Kafka 이벤트가 발행 실패되어도 재전송할 수 있습니다.

`CDC` 이외에도 `pooling`, `Scheduler`를 사용하여 OutBox 테이블을 모니터링할 수 있습니다.
## 3. 이벤트 발행 후 OutBox 테이블 정리
- 위 2번에서 정상적으로 이벤트가 발행되면 해당 이벤트를 `OutBox` 테이블에서 제거하거나 처리 완료 상태로 변경하여 불필요한 데이터가 `OutBox` 테이블에 쌓이는 것을 방지합니다.
## 참고 자료
- https://alswns7984.tistory.com/128
- https://blog.naver.com/pjt3591oo/223308097649
- https://velog.io/@joshuara7235/Kafka-%EB%A5%BC-%EC%B0%8D%EB%A8%B9%ED%95%B4%EB%B3%B4%EC%9E%90.-feat.-Transactional-Outbox-Pattern